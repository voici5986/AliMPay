name: Auto Sync Fork

on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹æ‰§è¡Œ
  schedule:
    - cron: '0 1 * * *'  # UTCæ—¶é—´1ç‚¹ = åŒ—äº¬æ—¶é—´9ç‚¹
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å½“upstreamæœ‰æ–°çš„pushæ—¶è§¦å‘ï¼ˆéœ€è¦webhooké…ç½®ï¼‰
  repository_dispatch:
    types: [upstream-sync]

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout fork repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²è®°å½•
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/ours1505/AliMPay.git
          git remote -v
      
      - name: Fetch upstream changes
        run: |
          git fetch upstream
          git fetch origin
      
      - name: Check for changes
        id: check_changes
        run: |
          # æ£€æŸ¥upstreamçš„mainåˆ†æ”¯æ˜¯å¦æœ‰æ–°çš„æäº¤
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          FORK_COMMIT=$(git rev-parse origin/main)
          
          echo "Upstream commit: $UPSTREAM_COMMIT"
          echo "Fork commit: $FORK_COMMIT"
          
          if [ "$UPSTREAM_COMMIT" != "$FORK_COMMIT" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
            echo "Changes detected, will proceed with sync"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected, skipping sync"
          fi
      
      - name: Sync main branch
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # åˆ‡æ¢åˆ°mainåˆ†æ”¯
          git checkout main
          
          # åˆå¹¶upstreamçš„mainåˆ†æ”¯
          git merge upstream/main --no-edit
          
          # æŽ¨é€åˆ°forkä»“åº“
          git push origin main
      
      - name: Create sync summary
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "## ðŸ”„ Fork Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Upstream Repository**: https://github.com/ours1505/AliMPay" >> $GITHUB_STEP_SUMMARY
          echo "- **Fork Repository**: https://github.com/voici5986/AliMPay" >> $GITHUB_STEP_SUMMARY
          echo "- **Sync Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Upstream Commit**: ${{ steps.check_changes.outputs.upstream_commit }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Sync Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          
          # èŽ·å–æœ€æ–°çš„æäº¤ä¿¡æ¯
          echo "### ðŸ“ Latest Changes" >> $GITHUB_STEP_SUMMARY
          git log --oneline -5 upstream/main >> $GITHUB_STEP_SUMMARY
      
      - name: No changes summary
        if: steps.check_changes.outputs.has_changes == 'false'
        run: |
          echo "## ðŸ”„ Fork Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Upstream Repository**: https://github.com/ours1505/AliMPay" >> $GITHUB_STEP_SUMMARY
          echo "- **Fork Repository**: https://github.com/voici5986/AliMPay" >> $GITHUB_STEP_SUMMARY
          echo "- **Sync Status**: â„¹ï¸ No changes detected" >> $GITHUB_STEP_SUMMARY
          echo "- **Check Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
      
      - name: Handle sync conflicts
        if: failure() && steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "## âš ï¸ Sync Failed" >> $GITHUB_STEP_SUMMARY
          echo "The automatic sync failed, likely due to conflicts." >> $GITHUB_STEP_SUMMARY
          echo "Please manually resolve conflicts:" >> $GITHUB_STEP_SUMMARY
          echo "1. \`git remote add upstream https://github.com/ours1505/AliMPay.git\`" >> $GITHUB_STEP_SUMMARY
          echo "2. \`git fetch upstream\`" >> $GITHUB_STEP_SUMMARY
          echo "3. \`git checkout main\`" >> $GITHUB_STEP_SUMMARY
          echo "4. \`git merge upstream/main\`" >> $GITHUB_STEP_SUMMARY
          echo "5. Resolve conflicts and push" >> $GITHUB_STEP_SUMMARY
